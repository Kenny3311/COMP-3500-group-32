<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Rider Dashboard</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="/rider.css" />			
	</head>
	<body>
		<div class="container py-5">
			<div class="position-relative mb-4">
				<h1 class="text-center">Rider Dashboard</h1>
				<a href="#rewardModal" class="reward-button position-absolute top-0 end-0" onclick="showRewards()">My Total Rewards</a>

				<div id="rewardModal" class="overlay">
					<div class="popup-card" id="popupCard">
						<h2>Total Rewards</h2>
						<p id="totalRewardAmount"><h4>$0.00</h4></p>
						<a class="close-button" href="#">Close</a>
					</div>
				</div>

			</div>

			<div class="order-list">
				<table class="table table-responsive" id="ordersTable">
					<thead>
						<tr>
							<th>Order ID</th>
							<th>Restaurant Name</th>
							<th>Restaurant Address</th>
							<th>Order Items</th>
							<th>Customer Name</th>
							<th>Customer Address</th>
							<th>Distance(m)</th>
							<th>Order Time</th>
							<th>Rewards</th>
							<th>Action</th>
						</tr>
					</thead>
					<tbody>
						<% if (orders && orders.length > 0) { %> <% orders.forEach(order => { %> 
						<tr id="order-<%= order.id %>">
							<td><%= order.id %></td>
							<td><%= order.restaurant_name %></td>
							<td><%= order.restaurant_address %></td>
							<td><%= order.context || "N/A" %></td>
							<td><%= order.customer_name %></td>
							<td><%= order.customer_address %></td>
							<td><%= order.distance_m %></td>
							<td><%= order.created_at %></td>
							<td>$ <%= order.rewards %></td>
							<td><button onclick="acceptOrder('<%= order.id %>')" class="accepted" >Accept</button></td>
						</tr>
						<% }); %> <% } else { %>
						<tr>
							<td colspan="10" style="text-align: center">No available orders</td>
						</tr>
						<% } %>
					</tbody>
				</table>
			</div>
		</div>
	</body>
</html>

<script>
	const riderName = "<%= riderNameIn%>";
	const totalRewards = <%= totalRewardsIn %>;
	
	function showRewards() {
		document.getElementById("totalRewardAmount").innerText = `$${totalRewards.toFixed(2)}`;
	}

async function acceptOrder(orderId) {
	const confirmAccept = confirm("Confirm to accept this order?");
	if (!confirmAccept) return;

	try {
		const res = await fetch(
			`/rider/accept/${orderId}`,
			{
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ rider_name: riderName }),
			}
		);

		let data = null;
		try {
			data = await res.json();
		} catch {
			throw new Error("Invalid JSON response from server");
		}

		if (!res.ok) {
			// ✅ Show server error message if available
			alert(data?.error || "❌ Failed to accept order");
			return;
		}

		// ✅ Redirect on success
		if (data.redirect) {
			window.location.href = data.redirect;
		} else {
			alert("❌ No redirect URL provided by server");
		}
	} catch (err) {
		console.error(err);
		alert("⚠️ Error connecting to server");
	}
}
</script>